# .github/workflows/dify_scheduled_report.yml

name: Dify Scheduled Report to WeChat

on:
  # 1. å®šæ—¶è§¦å‘ï¼šåœ¨åŒ—äº¬æ—¶é—´æ¯å¤©æ™šä¸Š 20:00 è¿è¡Œ
  # GitHub Actions ä½¿ç”¨ UTC æ—¶é—´ï¼ŒåŒ—äº¬æ—¶é—´ (UTC+8) 20:00 ç­‰äº UTC æ—¶é—´ 12:00
  schedule:
    - cron: '0 12 * * *'

  # 2. ä¿ç•™æ‰‹åŠ¨è§¦å‘ï¼Œæ–¹ä¾¿ä½ éšæ—¶æµ‹è¯•
  workflow_dispatch:

jobs:
  run_dify_and_notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # æ ¸å¿ƒæ­¥éª¤ä¸€ï¼šè°ƒç”¨ Dify å·¥ä½œæµ API
      - name: Call Dify Workflow API
        id: dify_call # ä¸ºæ­¥éª¤è®¾ç½® IDï¼Œæ–¹ä¾¿åç»­å¼•ç”¨å…¶è¾“å‡º
        run: |
          # å‘é€ POST è¯·æ±‚åˆ° Dify API
          # å› ä¸ºå·¥ä½œæµä¸éœ€è¦è¾“å…¥ï¼Œæ‰€ä»¥ "inputs" æ˜¯ä¸€ä¸ªç©ºå¯¹è±¡ {}
          response=$(curl -sS -X POST "${{ secrets.DIFY_WORKFLOW_URL }}" \
            -H "Authorization: Bearer ${{ secrets.DIFY_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "inputs": {},
              "response_mode": "blocking",
              "user": "github-actions-scheduled-job"
            }')

          # æ‰“å° Dify è¿”å›çš„åŸå§‹ JSONï¼Œè¿™å¯¹äºè°ƒè¯•è‡³å…³é‡è¦
          echo "Dify Raw Response:"
          echo "$response"

          # ä½¿ç”¨ jq è§£æ JSONï¼Œæå–ç»“æœ
          # !! é‡è¦ !!: è¿™ä¸ªè·¯å¾„ '.data.outputs.text' éœ€è¦æ ¹æ®ä½ çš„å·¥ä½œæµå®é™…è¾“å‡ºæ¥ä¿®æ”¹ã€‚
          # è¯·æŸ¥çœ‹ä¸Šé¢æ‰“å°çš„ "Dify Raw Response" æ¥ç¡®å®šæ­£ç¡®çš„è·¯å¾„ã€‚
          # ä¾‹å¦‚ï¼Œå¦‚æœä½ çš„è¾“å‡ºå˜é‡å« 'result', è·¯å¾„å¯èƒ½å°±æ˜¯ '.data.outputs.result'
          result=$(echo "$response" | jq -r '.data.outputs.text')

          # å°†æå–çš„ç»“æœè®¾ç½®ä¸ºè¯¥æ­¥éª¤çš„è¾“å‡ºå˜é‡ï¼Œä»¥ä¾¿ä¸‹ä¸€æ­¥ä½¿ç”¨
          # ä½¿ç”¨ç‰¹æ®Šæ ¼å¼æ¥å¤„ç†å¯èƒ½çš„å¤šè¡Œæ–‡æœ¬
          echo "result<<EOF" >> $GITHUB_OUTPUT
          echo "$result" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # æ ¸å¿ƒæ­¥éª¤äºŒï¼šå°†ç»“æœå‘é€åˆ° Serveré…±
      - name: Send result to ServerChan
        if: success() # ä»…å½“ä¸Šä¸€æ­¥æˆåŠŸæ—¶æ‰æ‰§è¡Œ
        run: |
          # ä½¿ç”¨ --data-urlencode æ¥ç¡®ä¿å†…å®¹ä¸­çš„ç‰¹æ®Šå­—ç¬¦è¢«æ­£ç¡®ç¼–ç 
          curl -sS -X POST "https://sctapi.ftqq.com/${{ secrets.SERVERCHAN_KEY }}.send" \
            --data-urlencode "title=ğŸ“… æ¯æ—¥Difyä»»åŠ¡æŠ¥å‘Š" \
            --data-urlencode "desp=${{ steps.dify_call.outputs.result }}"
