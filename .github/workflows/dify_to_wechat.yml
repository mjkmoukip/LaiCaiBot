# .github/workflows/dify_scheduled_report.yml

name: Dify Scheduled Report to WeChat

on:
  # 1. å®šæ—¶è§¦å‘ï¼šåœ¨åŒ—äº¬æ—¶é—´æ¯å¤©æ™šä¸Š 20:00 è¿è¡Œ
  # GitHub Actions ä½¿ç”¨ UTC æ—¶é—´ï¼ŒåŒ—äº¬æ—¶é—´ (UTC+8) 20:00 ç­‰äº UTC æ—¶é—´ 12:00
  schedule:
    - cron: '0 12 * * *'

  # 2. ä¿ç•™æ‰‹åŠ¨è§¦å‘ï¼Œæ–¹ä¾¿ä½ éšæ—¶æµ‹è¯•
  workflow_dispatch:

jobs:
  run_dify_and_notify:
    runs-on: ubuntu-latest
    # å¢åŠ ä¸€ä¸ªè¶…æ—¶è®¾ç½®ï¼Œé˜²æ­¢ Action æ— é™è¿è¡Œä¸‹å»ï¼Œæ¯”å¦‚æœ€å¤šè¿è¡Œ10åˆ†é’Ÿ
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # æ ¸å¿ƒæ­¥éª¤ï¼šè°ƒç”¨ Dify å¹¶è·å–ç»“æœ (å¼‚æ­¥è½®è¯¢)
      - name: Call Dify Workflow Asynchronously and Poll for Result
        id: dify_call_async
        run: |
          # --- æ­¥éª¤ 1: è§¦å‘å·¥ä½œæµå¹¶è·å– task_id ---
          # ä½¿ç”¨ "streaming" æ¨¡å¼ï¼Œå®ƒä¼šç«‹å³è¿”å›ä¸€ä¸ª task_id
          echo "Triggering Dify workflow in streaming mode..."
          trigger_response=$(curl -sS -X POST "${{ secrets.DIFY_WORKFLOW_URL }}" \
            -H "Authorization: Bearer ${{ secrets.DIFY_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "inputs": {},
              "response_mode": "streaming",
              "user": "github-actions-async-job"
            }')

          # ä»è¿”å›çš„ç¬¬ä¸€ä¸ªäº‹ä»¶ä¸­è§£æ task_id
          # æµå¼å“åº”ç”±å¤šè¡Œ `data: {...}` ç»„æˆï¼Œæˆ‘ä»¬åªå–ç¬¬ä¸€è¡Œ
          task_id=$(echo "$trigger_response" | grep '"event":"workflow_started"' | jq -r '.task_id')

          if [ -z "$task_id" ]; then
            echo "::error::Failed to get task_id from Dify. Response was:"
            echo "$trigger_response"
            exit 1
          fi
          echo "Workflow started with task_id: $task_id"

          # --- æ­¥éª¤ 2: è½®è¯¢ä»»åŠ¡çŠ¶æ€ ---
          # æ„é€ æŸ¥è¯¢çŠ¶æ€çš„ URL
          status_url="https://api.dify.ai/v1/tasks/${task_id}/result" # å¦‚æœæ˜¯è‡ªéƒ¨ç½²ï¼Œè¯·ä¿®æ”¹åŸŸå
          
          # è®¾ç½®è½®è¯¢å‚æ•°
          max_retries=55 # æœ€å¤šè½®è¯¢30æ¬¡
          sleep_interval=10 # æ¯æ¬¡é—´éš”10ç§’

          for (( i=1; i<=max_retries; i++ )); do
            echo "Polling attempt #$i..."
            status_response=$(curl -sS -X GET "$status_url" \
              -H "Authorization: Bearer ${{ secrets.DIFY_API_KEY }}")

            status=$(echo "$status_response" | jq -r '.status')
            echo "Current task status: $status"

            if [ "$status" == "succeeded" ]; then
              echo "Task succeeded!"
              # --- æ­¥éª¤ 3: æå–æœ€ç»ˆç»“æœ ---
              # !! é‡è¦ !!: åŒæ ·éœ€è¦æ ¹æ®ä½ çš„è¾“å‡ºå˜é‡åä¿®æ”¹ '.outputs.text'
              final_result=$(echo "$status_response" | jq -r '.outputs.text')
              
              # è®¾ç½®è¾“å‡ºå¹¶é€€å‡ºå¾ªç¯
              echo "result<<EOF" >> $GITHUB_OUTPUT
              echo "$final_result" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
              exit 0 # æˆåŠŸé€€å‡ºè„šæœ¬
            
            elif [ "$status" == "failed" ] || [ "$status" == "stopped" ]; then
              echo "::error::Task failed or was stopped. Full response:"
              echo "$status_response"
              exit 1 # å¤±è´¥é€€å‡ºè„šæœ¬
            fi

            # å¦‚æœä»»åŠ¡ä»åœ¨è¿è¡Œï¼Œåˆ™ç­‰å¾…ä¸€æ®µæ—¶é—´å†æŸ¥è¯¢
            sleep $sleep_interval
          done

          # å¦‚æœå¾ªç¯ç»“æŸä»»åŠ¡ä»æœªå®Œæˆï¼Œåˆ™è§†ä¸ºè¶…æ—¶
          echo "::error::Polling timed out after $(($max_retries * $sleep_interval)) seconds."
          exit 1


      # å°†ç»“æœå‘é€åˆ° Serveré…± (è¿™ä¸€æ­¥æ— éœ€ä¿®æ”¹)
      - name: Send result to ServerChan
        if: success()
        run: |
          curl -sS -X POST "https://sctapi.ftqq.com/${{ secrets.SERVERCHAN_KEY }}.send" \
            --data-urlencode "title=ğŸ“… æ¯æ—¥Difyä»»åŠ¡æŠ¥å‘Š (å¼‚æ­¥)" \
            --data-urlencode "desp=${{ steps.dify_call_async.outputs.result }}"
