# å·¥ä½œæµåç§°ï¼Œæ›´æ–°ä»¥åæ˜ æ–°åŠŸèƒ½
name: æ¯æ—¥å®šæ—¶è§¦å‘ Dify å·¥ä½œæµ (å¸¦ Serveré…±é€šçŸ¥)

on:
  # 1. å®šæ—¶è§¦å‘ï¼šåŒ—äº¬æ—¶é—´ (UTC+8) çš„æ™šä¸Š 8 ç‚¹ (UTC æ—¶é—´ 12:00)
  schedule:
    - cron: '0 12 * * *'

  # 2. æ‰‹åŠ¨è§¦å‘ï¼šå…è®¸åœ¨ Actions é¡µé¢æ‰‹åŠ¨è¿è¡Œæ­¤å·¥ä½œæµ
  workflow_dispatch:

jobs:
  trigger-dify-workflow:
    runs-on: ubuntu-latest # ä½¿ç”¨æœ€æ–°çš„ Ubuntu è¿è¡Œç¯å¢ƒ

    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç  (å¥½ä¹ æƒ¯)
      - name: Checkout repository
        uses: actions/checkout@v4

      # æ­¥éª¤ 2: è§¦å‘ Dify å·¥ä½œæµ
      # å¦‚æœæ­¤æ­¥éª¤å¤±è´¥ (ä¾‹å¦‚ï¼ŒDify API è¿”å› 4xx/5xx é”™è¯¯)ï¼Œåç»­çš„ "æˆåŠŸé€šçŸ¥" æ­¥éª¤å°†è¢«è·³è¿‡ï¼Œè€Œ "å¤±è´¥é€šçŸ¥" æ­¥éª¤å°†è¢«æ‰§è¡Œã€‚
      - name: Trigger Dify Workflow
        id: trigger # ä¸ºæ­¤æ­¥éª¤è®¾ç½®ä¸€ä¸ª idï¼Œæ–¹ä¾¿åç»­å¼•ç”¨ (è™½ç„¶æ­¤ç®€åŒ–ç‰ˆæœªç”¨åˆ°ï¼Œä½†ä¹Ÿæ˜¯å¥½ä¹ æƒ¯)
        run: |
          echo "Attempting to trigger Dify workflow..."
          
          # å‘é€ POST è¯·æ±‚åˆ° Dify å·¥ä½œæµ API
          # -f:  å¦‚æœæœåŠ¡å™¨è¿”å› HTTP é”™è¯¯ç  (4xx æˆ– 5xx)ï¼Œåˆ™ curl ä¼šä»¥é”™è¯¯çŠ¶æ€é€€å‡ºï¼Œä»è€Œä½¿æ­¤æ­¥éª¤å¤±è´¥
          http_status=$(curl -sS -f -o /dev/null -w "%{http_code}" \
            -X POST "${{ secrets.DIFY_WORKFLOW_URL }}" \
            -H "Authorization: Bearer ${{ secrets.DIFY_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "inputs": {},
              "response_mode": "streaming", 
              "user": "github-actions-serverchan-trigger"
            }')

          echo "Dify API HTTP response code: $http_status"

          # æ£€æŸ¥ HTTP çŠ¶æ€ç æ˜¯å¦è¡¨ç¤ºæˆåŠŸ (é€šå¸¸æ˜¯ 200 æˆ– 202)
          # curl çš„ -f é€‰é¡¹ä¼šå¤„ç†å¤±è´¥æƒ…å†µï¼Œè¿™é‡Œçš„æ£€æŸ¥æ˜¯ä¸ºäº†æ›´æ¸…æ™°çš„æ—¥å¿—è¾“å‡ºã€‚
          if [ "$http_status" -ge 200 ] && [ "$http_status" -lt 300 ]; then
            echo "Successfully triggered Dify workflow (HTTP $http_status)."
          else
            # è¿™ä¸€éƒ¨åˆ†å¯èƒ½ä¸ä¼šæ‰§è¡Œï¼Œå› ä¸º curl -f ä¼šè®©è„šæœ¬æå‰å¤±è´¥ï¼Œä½†ä½œä¸ºåŒé‡ä¿éšœä¿ç•™
            echo "::error::Failed to trigger Dify workflow. HTTP response code: $http_status"
            exit 1
          fi
        env:
          DIFY_WORKFLOW_URL: ${{ secrets.DIFY_WORKFLOW_URL }}
          DIFY_API_KEY: ${{ secrets.DIFY_API_KEY }}

      # æ­¥éª¤ 3: å‘é€æˆåŠŸé€šçŸ¥ (Serveré…±)
      # if: success() ç¡®ä¿åªæœ‰åœ¨å‰é¢çš„æ‰€æœ‰æ­¥éª¤éƒ½æˆåŠŸæ—¶æ‰è¿è¡Œæ­¤æ­¥éª¤
      - name: Send Success Notification via ServerChan
        if: success()
        run: |
          curl -sS --fail -X POST \
            -d "title=âœ… Dify å·¥ä½œæµè§¦å‘æˆåŠŸ" \
            -d "desp=å·¥ä½œæµ **'${{ github.workflow }}'** å·²æˆåŠŸè§¦å‘ã€‚%0A%0A- è§¦å‘æ–¹å¼: `${{ github.event_name }}`%0A- [ç‚¹æ­¤æŸ¥çœ‹è¿è¡Œæ—¥å¿—](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" \
            "https://sctapi.ftqq.com/${{ secrets.SERVERCHAN_KEY }}.send"
        env:
          SERVERCHAN_KEY: ${{ secrets.SERVERCHAN_KEY }}

      # æ­¥éª¤ 4: å‘é€å¤±è´¥é€šçŸ¥ (Serveré…±)
      # if: failure() ç¡®ä¿åªæœ‰åœ¨å‰é¢çš„ä»»ä½•æ­¥éª¤å¤±è´¥æ—¶æ‰è¿è¡Œæ­¤æ­¥éª¤
      - name: Send Failure Notification via ServerChan
        if: failure()
        run: |
          curl -sS --fail -X POST \
            -d "title=ğŸš¨ Dify å·¥ä½œæµè§¦å‘å¤±è´¥" \
            -d "desp=å·¥ä½œæµ **'${{ github.workflow }}'** è§¦å‘å¤±è´¥ï¼Œè¯·ç«‹å³æ£€æŸ¥ã€‚%0A%0A- è§¦å‘æ–¹å¼: `${{ github.event_name }}`%0A- [ç‚¹æ­¤æŸ¥çœ‹è¿è¡Œæ—¥å¿—](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" \
            "https://sctapi.ftqq.com/${{ secrets.SERVERCHAN_KEY }}.send"
        env:
          SERVERCHAN_KEY: ${{ secrets.SERVERCHAN_KEY }}
